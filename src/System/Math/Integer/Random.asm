; Copyright 2022 Raphtaliyah <me@raphtaliyah.moe>
;---------------------------------------------------------------------
; Module
;---------------------------------------------------------------------
    .module Random
;---------------------------------------------------------------------
; Global symbols
;---------------------------------------------------------------------
    .globl getFrameCounter
;---------------------------------------------------------------------
; Includes
;---------------------------------------------------------------------
    .include \src/Headers/Random.h.asm\
;---------------------------------------------------------------------
; Memory initializers
;---------------------------------------------------------------------
    .area INIT (CSEG)
    .area XINIT (CSEG)
;---------------------------------------------------------------------
; Memory
;---------------------------------------------------------------------
    .area BIT   (DSEG)
    .area DATA  (DSEG)
    .area XDATA (DSEG)
    localOffset:
        .ds 1
;---------------------------------------------------------------------
; Constant data
;---------------------------------------------------------------------
    .area CODE (CSEG)
    randomTable:
        .db 246, 105, 180,  45,  27,   6,  20, 143, 151, 162, 194
        .db  28, 137, 254,  46, 250, 198, 238,  87,  75, 223,  38
        .db   8, 147, 159, 104, 219, 139, 235, 216,  97,  52, 245
        .db 181, 102,  73, 133, 167,  92,  94, 234, 173, 176,  22
        .db  59, 100, 215,  48,  98,  53, 120,  74, 149,  80,  64
        .db 155, 213, 171,  55,  11, 123, 193, 164, 236, 152,  26
        .db  71,  82,  17, 134, 170, 253,  16, 230, 107,  79, 145
        .db  18,  77, 210, 211, 138,  13, 218, 207, 148,   1,   0
        .db 166,  33, 240, 225,  89, 116, 221, 117,  65, 190,  72
        .db  47, 112,  84, 106,  90, 182, 241,  93,  83, 227,  40
        .db 249, 115, 118, 121, 144, 154, 244, 208,  12, 146, 222
        .db 157, 229, 217, 114,  63, 197, 126, 212,  91,  23,   7
        .db 199, 206, 141,  88,  50, 128,   3,  67,  29,  25,  69
        .db 192, 122, 140, 101, 196,  24, 150, 195, 110,   5, 228
        .db 135, 214, 200, 161,  62, 205,  54,   9, 232, 108,  86
        .db  35, 179, 127, 103, 109, 113,  37,  34, 174, 239,   4
        .db 188,  76, 178,  31,  10, 156,  66, 136, 220, 191,  96
        .db 119,  36, 203,  19, 130,  21,  60, 248, 252, 247, 231
        .db  85,   2, 168, 255,  15, 169, 209,  78,  41, 125,  42
        .db 142, 131, 153, 251,  58, 165,  95, 243,  43, 160, 172
        .db 184, 224, 158, 237,  49,  32, 177,  70,  44, 175,  56
        .db 233, 185, 124,  51,  39, 111,  30, 132, 187,  14, 202
        .db 201, 189, 129, 226,  99,  57,  68,  81,  61, 204, 186
        .db 163, 183
;---------------------------------------------------------------------
; Constants
;---------------------------------------------------------------------
    
;---------------------------------------------------------------------
; Code
;---------------------------------------------------------------------
    .area CODE (CSEG)

;--------------------------------------------
; Generates a 8 bit random number.
;--------------------------------------------
; Parameters:
;	none
; Returns:
;	r0 - Random number.
;--------------------------------------------
nextRandom:
    push a
    push r1
    push r2
    push dpl
    push dph
    
    lcall getFrameCounter       ; Use the low byte of the frame
    mov   dptr,  #localOffset   ; counter plus a counter as the
    movx  a,     @dptr          ; offset into the random table.
    inc   a
    movx  @dptr, a
    add   a,     r0
    mov   dptr,  #randomTable
    movc  a,     @a+dptr
    mov   r0,    a
    
    pop dph
    pop dpl
    pop r2
    pop r1
    pop a
    ret